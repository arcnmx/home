name: $(TeamProject).$(Build.DefinitionName).$(BuildID)$(Rev:.r)_$(SourceBranchName).$(Date:yyyyMMdd).$(Build.Reason)
resources:
  repositories:
  - repository: ci
    type: github
    name: arcnmx/ci
    ref: refs/heads/master
    endpoint: github/arcnmx/ci
variables:
  CI_ALLOW_ROOT: true
  CI_CLOSE_STDIN: true
  CACHIX_CACHE: arc
  TERM: linux
  HOSTNAMES: satorin shanghai
  imageLinux: ubuntu-latest
stages:
- stage: build
  displayName: Build
  jobs:
  - job: home
    displayName: Home
    timeoutInMinutes: 0
    pool:
      vmImage: ${{variables.imageLinux}}
    steps:
    - checkout: self
      submodules: false
    - bash: git submodule update --init 'channels/*'
      displayName: git submodule init
    - template: azure/nix/install.yml@ci
      parameters:
        ciVersion: master
        config: config/ci.nix
    - bash: |
        (for host in $HOSTNAMES base personal desktop laptop; do
          echo BUILDING home-manager/$host &&
          ./nx home $host build || exit $?
        done)
      displayName: build home
    - bash: |
        (for host in $HOSTNAMES; do
          echo BUILDING nixos/$host &&
          ./nx switch $host build || exit $?
        done)
      displayName: build nixos
